
<!doctype html>
<html>
  <head>
    <title>bash</title>
    <!--
    <link rel="stylesheet" href="/scripts/xterm/dist/xterm.css" />
    <link rel="stylesheet" href="/scripts/xterm/dist/addons/fullscreen/fullscreen.css" />
    <script src="/scripts/xterm/dist/xterm.js"></script>
    <script src="/scripts/xterm/dist/addons/fit/fit.js"></script>
    <script src="/scripts/xterm/dist/addons/attach/attach.js"></script>
  -->
  <link rel="stylesheet" href="./resources/xterm.css" />
  <link rel="stylesheet" href="./resources/fullscreen.css" />
  <script src="./resources/xterm.js"></script>
  <script src="./resources/fit.js"></script>
  <script src="./resources/attach.js"></script>
  </head>
  <body>
    <div id="terminal"></div>
    <script>
      function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
      }  
      var sshPort = getParameterByName("sshPort");
      var user = getParameterByName("user");
      var id = getParameterByName("id");
      console.log('sshPort=' +sshPort + ' user='  + user);
      // No idea what these are about. Just copied them from the demo code
      Terminal.applyAddon(attach);
      Terminal.applyAddon(fit);
      // The terminal
      const term = new Terminal();
      //term.winptyCompatInit();
      const container = document.getElementById('terminal');
      term.open(container);
      term.resize(40, 35);
      if (term.element) {
        // term.fit();
      }
      
      // Open the websocket connection to the backend
      const protocol = (location.protocol === 'https:') ? 'wss://' : 'ws://';
      const port = location.port ? `:${location.port}` : '';
      const socketUrl = `${protocol}${location.hostname}${port}/shell` + 
          '?id=' + id +'&sshPort=' + sshPort + '&user=' + user;
      console.log(socketUrl);
      const socket = new WebSocket(socketUrl);
      // Attach the socket to the terminal
      socket.onopen = (ev) => { term.attach(socket); };
      socket.onclose = (ev) => { 
        console.log("WS CLOSED!", ev);
        if(confirm("Reconnect ?")){
          location.reload();
        }
      };
    </script>
  </body>
</html>
